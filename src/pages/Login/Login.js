import React, { useContext, useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import login from "./login.module.css";
import common from "../../common.module.css";

import { Link } from "react-router-dom";
import { REGISTARTION_ROUTE, SHOP_ROUTE } from "../../utils/consts";
import { Context } from "../..";
import { observer } from "mobx-react-lite";
import { login_1 } from "../../http/userAPI";
import CreateItem from "../../components/CreateItem/CreateItem";

const Login = observer(() => {
  const { user } = useContext(Context);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [emailDirty, setEmailDirty] = useState(false);
  const [passwordDirty, setPasswordDirty] = useState(false);
  const [emailError, setEmailError] = useState("Емейл не может быть пустым");
  const [passwordError, setPasswordError] = useState(
    "Пароль не может быть пустым"
  );
  const [formValid, setFormValid] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = (e) => {
    e.preventDefault();
  };

  useEffect(() => {
    if (emailError || passwordError) {
      setFormValid(false);
    } else {
      setFormValid(true);
    }
  }, [emailError, passwordError]);

  const emailHandler = (e) => {
    setEmail(e.target.value);
    const re =
      /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    if (!re.test(String(e.target.value).toLowerCase())) {
      setEmailError("Неккоректный емейл");
    } else {
      setEmailError("");
    }
  };

  const passwordHandler = (e) => {
    setPassword(e.target.value);

    if (e.target.value.length < 4 || e.target.value.length > 15) {
      setPasswordError("Пароль должен быть длиннее 4 и меньше 15 символов");
      if (e.target.value === "") {
        setPasswordError("Пароль не может быть пустым");
      }
    } else {
      setPasswordError("");
    }
  };

  const blurHandler = (e) => {
    switch (e.target.name) {
      case "email":
        setEmailDirty(true);
        break;
      case "password":
        setPasswordDirty(true);
        break;
    }
  };

  const logOut = () => {
    user.setUser({});
    user.setIsAuth(false);
  };

  const logIn = async () => {
    let data;
    data = await login_1(email, password);
    console.log(data);
    user.setUser(user);
    user.setIsAuth(true);
    navigate(SHOP_ROUTE);
  };

  return (
    <div className={login.login}>
      <div className={common.container_1300px}>
        <div className={login.login_block}>
          <Link to={SHOP_ROUTE}>
            <svg
              width="220"
              height="100"
              viewBox="0 0 86 54"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M0.787865 7.49666C0.583603 7.49666 0.481473 6.86459 0.481473 5.60045C0.481473 2.1608 0.758685 0.440982 1.31311 0.440982H15.2758C15.4801 0.440982 15.9324 1.08775 16.6327 2.38129C17.333 3.67483 17.6832 4.4098 17.6832 4.58619C17.6832 4.73319 17.6686 4.82138 17.6394 4.85078L9.14798 15.6107L16.764 15.0815C17.2309 15.0815 17.4643 16.1252 17.4643 18.2125C17.4643 19.0062 17.3914 19.9176 17.2455 20.9466C17.0996 21.9755 16.8515 22.49 16.5014 22.49H2.4949C2.0572 22.49 1.53196 21.755 0.919175 20.2851C0.306392 18.8151 0 17.9332 0 17.6392C0 17.3158 0.0291802 17.1247 0.0875405 17.0659L8.44766 7.23207L0.787865 7.49666Z"
                fill="black"
              />
              <path
                d="M24.3845 6.48241C23.5674 5.01247 23.1589 3.82183 23.1589 2.91047C23.1589 1.96971 23.4069 1.36704 23.903 1.10245C25.5663 0.367484 27.8423 0 30.7312 0C33.6492 0 35.7064 0.690869 36.9028 2.07261C38.0992 3.42495 38.6973 5.43875 38.6973 8.11403V15.0815H40.1855C40.6816 15.0815 41.0609 15.3755 41.3236 15.9635C41.6154 16.5515 41.7613 17.3599 41.7613 18.3889C41.7613 19.4178 41.4986 20.4321 40.9734 21.4316C40.4773 22.4312 39.7916 22.931 38.9162 22.931C37.3405 22.931 36.0711 22.5047 35.1082 21.6521C34.6705 21.2993 34.3349 20.8731 34.1015 20.3733C32.7592 22.0784 30.6728 22.931 27.8423 22.931C25.7122 22.931 23.9176 22.1666 22.4586 20.6379C20.9996 19.1091 20.2701 17.3011 20.2701 15.2138C20.2701 10.4218 23.1151 8.02584 28.8053 8.02584H31.2126V7.58486C31.2126 6.82049 31.0813 6.33541 30.8187 6.12962C30.5853 5.89443 30.0162 5.77684 29.1117 5.77684C28.0028 5.77684 26.4271 6.01203 24.3845 6.48241ZM27.8861 14.5964C27.8861 15.2432 28.0612 15.743 28.4113 16.0958C28.7615 16.4192 29.1992 16.5808 29.7244 16.5808C30.2789 16.5808 30.7749 16.3604 31.2126 15.9194V12.5238H29.9871C28.5864 12.5238 27.8861 13.2147 27.8861 14.5964Z"
                fill="black"
              />
              <path
                d="M45.0266 7.49666C44.8223 7.49666 44.7202 6.86459 44.7202 5.60045C44.7202 2.1608 44.9974 0.440982 45.5518 0.440982H59.5145C59.7188 0.440982 60.1711 1.08775 60.8714 2.38129C61.5718 3.67483 61.9219 4.4098 61.9219 4.58619C61.9219 4.73319 61.9073 4.82138 61.8781 4.85078L53.3867 15.6107L61.0027 15.0815C61.4696 15.0815 61.7031 16.1252 61.7031 18.2125C61.7031 19.0062 61.6301 19.9176 61.4842 20.9466C61.3383 21.9755 61.0903 22.49 60.7401 22.49H46.7336C46.2959 22.49 45.7707 21.755 45.1579 20.2851C44.5451 18.8151 44.2387 17.9332 44.2387 17.6392C44.2387 17.3158 44.2679 17.1247 44.3263 17.0659L52.6864 7.23207L45.0266 7.49666Z"
                fill="black"
              />
              <path
                d="M68.6232 6.48241C67.8062 5.01247 67.3976 3.82183 67.3976 2.91047C67.3976 1.96971 67.6457 1.36704 68.1417 1.10245C69.805 0.367484 72.0811 0 74.9699 0C77.8879 0 79.9451 0.690869 81.1415 2.07261C82.3379 3.42495 82.9361 5.43875 82.9361 8.11403V15.0815H84.4243C84.9203 15.0815 85.2997 15.3755 85.5623 15.9635C85.8541 16.5515 86 17.3599 86 18.3889C86 19.4178 85.7374 20.4321 85.2121 21.4316C84.7161 22.4312 84.0303 22.931 83.1549 22.931C81.5792 22.931 80.3099 22.5047 79.3469 21.6521C78.9092 21.2993 78.5736 20.8731 78.3402 20.3733C76.9979 22.0784 74.9115 22.931 72.0811 22.931C69.9509 22.931 68.1563 22.1666 66.6973 20.6379C65.2383 19.1091 64.5088 17.3011 64.5088 15.2138C64.5088 10.4218 67.3539 8.02584 73.044 8.02584H75.4514V7.58486C75.4514 6.82049 75.3201 6.33541 75.0574 6.12962C74.824 5.89443 74.255 5.77684 73.3504 5.77684C72.2415 5.77684 70.6658 6.01203 68.6232 6.48241ZM72.1248 14.5964C72.1248 15.2432 72.2999 15.743 72.6501 16.0958C73.0002 16.4192 73.4379 16.5808 73.9632 16.5808C74.5176 16.5808 75.0137 16.3604 75.4514 15.9194V12.5238H74.2258C72.8252 12.5238 72.1248 13.2147 72.1248 14.5964Z"
                fill="black"
              />
              <path
                d="M1.79458 45.6214C4.15817 47.0619 6.0257 47.7822 7.39717 47.7822C8.27258 47.7822 8.71028 47.4735 8.71028 46.8561C8.71028 46.4151 7.9516 45.8419 6.43423 45.1363C2.78671 43.637 0.962946 41.1822 0.962946 37.7719C0.962946 35.5964 1.75081 33.9354 3.32654 32.7889C4.90227 31.6423 6.78439 31.069 8.9729 31.069C11.1906 31.069 13.0581 31.3042 14.5755 31.7746C16.122 32.245 16.8953 32.8624 16.8953 33.6267C16.8953 34.2735 16.5743 35.1261 15.9324 36.1844C15.3196 37.2428 14.8965 37.816 14.663 37.9042C13.4083 37.1987 12.0514 36.8459 10.5924 36.8459C9.80454 36.8459 9.4106 37.1252 9.4106 37.6837C9.4106 38.0365 9.55651 38.3452 9.84831 38.6098C10.1693 38.845 10.7383 39.1537 11.5553 39.5359C12.3724 39.8886 13.0435 40.212 13.5688 40.506C14.1232 40.8 14.736 41.2116 15.4071 41.7408C16.8078 42.8579 17.5081 44.3131 17.5081 46.1065C17.5081 48.4584 16.7348 50.3693 15.1883 51.8392C13.6417 53.2797 11.3073 54 8.18504 54C6.11325 54 4.23112 53.6472 2.53867 52.9417C0.846225 52.2361 0 51.2659 0 50.0312C0 49.208 0.189671 48.3408 0.569013 47.4294C0.977536 46.518 1.38606 45.9154 1.79458 45.6214Z"
                fill="black"
              />
              <path
                d="M24.2135 37.5514C23.3965 36.0815 22.9879 34.8909 22.9879 33.9795C22.9879 33.0388 23.236 32.4361 23.732 32.1715C25.3953 31.4365 27.6713 31.069 30.5602 31.069C33.4782 31.069 35.5354 31.7599 36.7318 33.1417C37.9282 34.494 38.5264 36.5078 38.5264 39.1831V46.1506H40.0146C40.5106 46.1506 40.89 46.4445 41.1526 47.0325C41.4444 47.6205 41.5903 48.429 41.5903 49.4579C41.5903 50.4869 41.3277 51.5011 40.8024 52.5007C40.3064 53.5002 39.6206 54 38.7452 54C37.1695 54 35.9002 53.5737 34.9372 52.7212C34.4995 52.3684 34.1639 51.9421 33.9305 51.4423C32.5882 53.1474 30.5018 54 27.6713 54C25.5412 54 23.7466 53.2356 22.2876 51.7069C20.8286 50.1782 20.0991 48.3702 20.0991 46.2829C20.0991 41.4909 22.9442 39.0949 28.6343 39.0949H31.0417V38.6539C31.0417 37.8895 30.9103 37.4045 30.6477 37.1987C30.4143 36.9635 29.8453 36.8459 28.9407 36.8459C27.8318 36.8459 26.2561 37.0811 24.2135 37.5514ZM27.7151 45.6655C27.7151 46.3123 27.8902 46.812 28.2404 47.1648C28.5905 47.4882 29.0282 47.6499 29.5535 47.6499C30.1079 47.6499 30.604 47.4294 31.0417 46.9884V43.5929H29.8161C28.4154 43.5929 27.7151 44.2837 27.7151 45.6655Z"
                fill="black"
              />
              <path
                d="M45.8623 45.6214C48.2259 47.0619 50.0935 47.7822 51.4649 47.7822C52.3403 47.7822 52.778 47.4735 52.778 46.8561C52.778 46.4151 52.0193 45.8419 50.502 45.1363C46.8545 43.637 45.0307 41.1822 45.0307 37.7719C45.0307 35.5964 45.8186 33.9354 47.3943 32.7889C48.97 31.6423 50.8521 31.069 53.0407 31.069C55.2583 31.069 57.1259 31.3042 58.6432 31.7746C60.1898 32.245 60.9631 32.8624 60.9631 33.6267C60.9631 34.2735 60.6421 35.1261 60.0001 36.1844C59.3873 37.2428 58.9642 37.816 58.7308 37.9042C57.476 37.1987 56.1192 36.8459 54.6602 36.8459C53.8723 36.8459 53.4784 37.1252 53.4784 37.6837C53.4784 38.0365 53.6243 38.3452 53.9161 38.6098C54.237 38.845 54.8061 39.1537 55.6231 39.5359C56.4401 39.8886 57.1113 40.212 57.6365 40.506C58.191 40.8 58.8037 41.2116 59.4749 41.7408C60.8755 42.8579 61.5759 44.3131 61.5759 46.1065C61.5759 48.4584 60.8026 50.3693 59.256 51.8392C57.7095 53.2797 55.3751 54 52.2528 54C50.181 54 48.2989 53.6472 46.6064 52.9417C44.914 52.2361 44.0678 51.2659 44.0678 50.0312C44.0678 49.208 44.2574 48.3408 44.6368 47.4294C45.0453 46.518 45.4538 45.9154 45.8623 45.6214Z"
                fill="black"
              />
              <path
                d="M68.2812 37.5514C67.4642 36.0815 67.0557 34.8909 67.0557 33.9795C67.0557 33.0388 67.3037 32.4361 67.7998 32.1715C69.463 31.4365 71.7391 31.069 74.6279 31.069C77.546 31.069 79.6032 31.7599 80.7995 33.1417C81.9959 34.494 82.5941 36.5078 82.5941 39.1831V46.1506H84.0823C84.5784 46.1506 84.9577 46.4445 85.2203 47.0325C85.5121 47.6205 85.658 48.429 85.658 49.4579C85.658 50.4869 85.3954 51.5011 84.8702 52.5007C84.3741 53.5002 83.6884 54 82.813 54C81.2372 54 79.9679 53.5737 79.005 52.7212C78.5673 52.3684 78.2317 51.9421 77.9982 51.4423C76.656 53.1474 74.5696 54 71.7391 54C69.6089 54 67.8144 53.2356 66.3554 51.7069C64.8964 50.1782 64.1668 48.3702 64.1668 46.2829C64.1668 41.4909 67.0119 39.0949 72.702 39.0949H75.1094V38.6539C75.1094 37.8895 74.9781 37.4045 74.7155 37.1987C74.482 36.9635 73.913 36.8459 73.0084 36.8459C71.8996 36.8459 70.3239 37.0811 68.2812 37.5514ZM71.7829 45.6655C71.7829 46.3123 71.9579 46.812 72.3081 47.1648C72.6583 47.4882 73.096 47.6499 73.6212 47.6499C74.1756 47.6499 74.6717 47.4294 75.1094 46.9884V43.5929H73.8839C72.4832 43.5929 71.7829 44.2837 71.7829 45.6655Z"
                fill="black"
              />
            </svg>
          </Link>
          {user.isAuth ? (
            <div className={login.logout_block}>
              <div onClick={logOut} className={login.logout_button}>
                Log Out
              </div>
              {/* <CreateItem /> */}
            </div>
          ) : (
            <>
              <h3 className={login.login_header}>Вход или регистрация</h3>
              <p className={login.login_small_text}>
                Введите свой email, мы отправим вам письмо с кодом подтверждения
              </p>
              <form className={login.login_form} onSubmit={handleSubmit}>
                {emailDirty && emailError && (
                  <div className={login.login_uncorrect}>{emailError}</div>
                )}
                <input
                  className={login.login_text_field}
                  name="email"
                  placeholder="Введите email"
                  value={email}
                  onBlur={(e) => blurHandler(e)}
                  onChange={(e) => emailHandler(e)}
                ></input>
                {passwordDirty && passwordError && (
                  <div className={login.login_uncorrect}>{passwordError}</div>
                )}
                <input
                  className={login.login_text_field}
                  type="password"
                  name="password"
                  placeholder="Введите пароль"
                  value={password}
                  onBlur={(e) => blurHandler(e)}
                  onChange={(e) => passwordHandler(e)}
                ></input>
                <button
                  className={login.login_submit}
                  onClick={logIn}
                  disabled={!formValid}
                >
                  Продолжить
                </button>
              </form>
              <Link to={REGISTARTION_ROUTE} className={login.login_link}>
                У меня нет аккаунта
              </Link>
            </>
          )}
        </div>
      </div>
    </div>
  );
});

export default Login;
